<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LOOKERIN • Mini Job Portal</title>
  <meta name="description" content="LOOKERIN – by SIMGROUP. Mini job portal dengan filter Branch → Area → Group Job (dependent), tampilan mobile & web, kartu kapsul, popup detail + Apply. Fokus: load data sempurna (CSV/JSON robust), cepat (cache + pager), fallback andal."/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --brand:#1BAFBF; --brand-ink:#0d5c66; --ink:#0f172a; --muted:#f1f5f9; --line:#e2e8f0; --bg:#ffffff; --card:#ffffff;
      --shadow:0 6px 20px rgba(0,0,0,.06); --radius:18px; --sticky-top:0px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink);
      background:
        var(--bg),
        radial-gradient(1200px 800px at 12% 18%, rgba(148,163,184,.5), transparent 60%),
        radial-gradient(1400px 900px at 88% 8%, rgba(100,116,139,.5), transparent 62%),
        radial-gradient(900px 1100px at 46% 94%, rgba(71,85,105,.5), transparent 60%),
        conic-gradient(from 180deg at 60% 40%, rgba(100,116,139,.16) 0deg, rgba(100,116,139,0) 120deg, rgba(100,116,139,.16) 240deg, rgba(100,116,139,0) 360deg);
      background-attachment: fixed,fixed,fixed,fixed,fixed;
      background-repeat:no-repeat;background-size:auto,cover,cover,cover,cover;background-position:center,center,center,center,center;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:20px 16px 80px}

    /* Header dengan Logo PNG */
    header{position:sticky;top:0;z-index:30;background:linear-gradient(180deg, rgba(255,255,255,.98), rgba(255,255,255,.92));backdrop-filter:saturate(140%) blur(6px);border-bottom:1px solid var(--line)}
    .head-inner{max-width:1100px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;gap:14px}
    .brand{display:flex;align-items:center;gap:10px;min-height:44px}
    .brand img{height:36px;width:auto;display:block;object-fit:contain;filter: drop-shadow(0 2px 6px rgba(0,0,0,.08));}
    .title{display:flex;flex-direction:column}
    .title h1{font-size:20px;line-height:1.1;margin:0;letter-spacing:.4px;font-weight:800;color:var(--brand-ink)}
    .title p{margin:2px 0 0;font-size:12px;color:#475569;font-weight:600}
    .hamburger{margin-left:auto;display:none;align-items:center;gap:8px;border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 12px;font-weight:800;cursor:pointer}
    .hamburger svg{width:18px;height:18px}

    /* Filters */
    .filters{position:sticky; top:calc(var(--sticky-top)); z-index:25; margin:18px 0 10px;background:var(--muted);border:1px solid var(--line);padding:12px;border-radius:16px;box-shadow:var(--shadow)}
    .filters .row{display:flex;flex-wrap:wrap;gap:10px}
    .fgrp{display:flex;align-items:center;gap:8px;background:#fff;border:1px solid var(--line);padding:8px 10px;border-radius:12px}
    .fgrp label{font-size:12px;color:#334155;font-weight:700}
    .fgrp select{appearance:auto;border:none;outline:none;font-size:13px;padding:6px 8px;background:#fff;color:#0f172a;min-width:220px}
    .fgrp select:disabled{opacity:.55;cursor:not-allowed;background:#f8fafc}

    /* highlight select penting */
    .fgrp:has(#f-branch), .fgrp:has(#mf-branch),
    .fgrp:has(#f-area), .fgrp:has(#mf-area){
      background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(248,250,252,.90)) padding-box,
                  linear-gradient(180deg, #e2e8f0, #cbd5e1) border-box;
      border:1px solid transparent; box-shadow: inset 0 1px 0 rgba(255,255,255,.85), inset 0 -6px 12px rgba(255,255,255,.45), var(--shadow);
      position:relative;
    }
    .fgrp:has(#f-branch)::after, .fgrp:has(#mf-branch)::after,
    .fgrp:has(#f-area)::after, .fgrp:has(#mf-area)::after{
      content:""; position:absolute; left:6px; right:6px; top:4px; height:40%; border-radius:10px;
      background: linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,0)); pointer-events:none;
    }
    #f-branch, #mf-branch, #f-area, #mf-area{
      background: linear-gradient(180deg, rgba(255,255,255,.99), rgba(248,250,252,.92));
      border:1px solid #cbd5e1; border-radius:10px; box-shadow: inset 0 1px 0 rgba(255,255,255,.8);
      padding:6px 10px;
    }

    .f-actions{margin-left:auto;display:flex;gap:8px}
    .btn{border:none;outline:none;border-radius:999px;padding:10px 14px;font-weight:700;letter-spacing:.2px;cursor:pointer}
    .btn-primary{background:var(--brand);color:#00323a}
    .btn-ghost{background:#fff;color:#0f172a;border:1px solid var(--line)}

    #btn-clear, #mf-clear{
      background: linear-gradient(180deg, #ffffff 0%, #f1f5f9 100%); border:1px solid #cbd5e1;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.9), 0 8px 0 rgba(15,23,42,.08), 0 10px 24px rgba(2,6,23,.08);
      text-shadow: 0 1px 0 rgba(255,255,255,.7);
      transition: transform .06s ease, box-shadow .12s ease, filter .2s ease;
      padding:8px 12px;
    }
    #btn-apply, #mf-apply{
      background: linear-gradient(180deg, #2ad4d4 0%, #16a0a8 70%); border:1px solid #0e6771;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.65), 0 8px 0 rgba(13,92,102,.18), 0 10px 24px rgba(2,6,23,.10);
      color:#00323a; text-shadow: 0 1px 0 rgba(255,255,255,.35);
      transition: transform .06s ease, box-shadow .12s ease, filter .2s ease;
      padding:8px 12px;
    }

    /* Grid */
    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:14px;min-height:40vh}
    @media (max-width:960px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:640px){
      .grid{grid-template-columns:1fr;gap:10px}
      .filters{display:none}
      .hamburger{display:inline-flex}
    }

    /* Card */
    .card{position:relative;border:1px solid var(--line);background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px 14px 48px;transition:transform .15s ease, box-shadow .15s ease, border-color .15s ease; cursor:pointer}
    .card:hover{transform:translateY(-2px);box-shadow:0 10px 24px rgba(0,0,0,.08);border-color:#bae6fd}
    .card:focus{outline:2px solid #bae6fd; outline-offset:2px}

    .cap-status{position:absolute;top:10px;right:10px;background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow);padding:6px 8px;display:grid;grid-auto-flow:row;justify-items:center;gap:2px;min-width:64px}
    .cap-status .ico{line-height:0}
    .cap-status .ico svg{width:18px;height:18px}
    .cap-status .lbl{font-size:10px;font-weight:800;letter-spacing:.3px;text-transform:uppercase;white-space:nowrap;color:#0b4c57}
    .cap-status.urgent .lbl{color:#b42318}
    .cap-status.hiring .lbl{color:#067647}
    .cap-status.urgent .ico svg{color:#ef4444}
    .cap-status.hiring .ico svg{color:#10b981}

    .card-ft{position:absolute;right:12px;bottom:12px;display:flex;gap:8px}
    .pill{border:1px solid var(--line);background:#fff;border-radius:999px;padding:6px 10px;font:800 11px/1 Montserrat;letter-spacing:.3px;display:inline-flex;align-items:center;gap:6px;cursor:pointer}
    .pill-detail{background:linear-gradient(180deg,#76e4ef 0%, #22d3ee 60%, #0ea5b8 100%); border-color:#0ea5b8; color:#ffffff; box-shadow: inset 0 1px 0 rgba(255,255,255,.55), var(--shadow);}
    .pill-detail:hover{filter:brightness(0.98)}
    .pill-detail:active{transform:translateY(1px)}

    .job-title,.job-parent{display:flex;align-items:center;gap:8px}
    .job-title{margin:2px 0 4px;font-size:12px;font-weight:800;color:#083344}
    .job-parent{font-size:10px;font-weight:600;color:#0b4c57;margin:2px 0 8px}
    .i{display:inline-flex;align-items:center;justify-content:center;line-height:0;color:var(--brand)}
    .job-title .i svg{width:16px;height:16px}
    .job-parent .i svg{width:14px;height:14px;opacity:.95}

    .loc{display:flex;align-items:center;gap:8px;font-size:12px;color:#0b3d44}
    .loc svg{width:16px;height:16px;flex:0 0 auto}
    .sal{display:flex;align-items:center;gap:8px;font-size:12px;color:#075e62;margin-top:6px}
    .sal svg{width:16px;height:16px;flex:0 0 auto}

    /* Pager */
    .pager{display:flex;align-items:center;justify-content:center;gap:10px;margin-top:14px;position:sticky;bottom:0;background:linear-gradient(180deg,transparent, #fff 40%);padding:8px 0;z-index:10}
    .page-info{font:600 12px/1.4 Montserrat,system-ui}

    /* Status */
    .status{padding:24px;text-align:center;color:#334155}

    /* Modal */
    dialog{width:min(700px, 94vw);border:none;border-radius:20px;padding:0;box-shadow:0 30px 80px rgba(0,0,0,.35)}
    #dlg::backdrop{backdrop-filter: blur(6px); background: rgba(0,0,0,.2)}
    .modal{padding:18px 18px 16px}
    .modal .title h2{font-size:20px;color:#062e33;margin:0}
    .modal .sub{margin:6px 0 10px;font-size:13px;color:#0b4c57;font-weight:700}
    .modal .meta{display:flex;align-items:center;gap:8px;color:#083344;font-size:13px}
    .modal .meta svg{width:18px;height:18px}
    .modal .qual{margin-top:14px;font-size:14px;line-height:1.5;color:#0f172a;background:var(--muted);padding:14px;border-radius:12px;border:1px solid var(--line);max-height:min(46vh,420px);overflow:auto}
    .modal .qual ul{margin:0; padding-left:18px}
    .modal .actions{margin-top:16px;display:flex;gap:10px;justify-content:flex-end}
    .x{position:absolute;top:8px;right:10px;border:none;background:transparent;font-size:22px;line-height:1;cursor:pointer;color:#0f172a}
    .apply-btn{display:inline-flex;align-items:center;gap:8px}
    .apply-btn svg{color:#d72638}

    /* Dialog Filter Mobile */
    #dlg-filter::backdrop{background:rgba(0,0,0,.4)}
    #dlg-filter{width:min(520px,96vw);border:none;border-radius:16px;padding:0;overflow:hidden}
    .mfilter-hd{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line);background:#fff}
    .mfilter-bd{padding:14px;background:var(--muted)}
    .mfilter-row{display:flex;flex-direction:column;gap:8px}
    .mfilter-row .fgrp{width:100%}
    .mfilter-ft{display:flex;justify-content:flex-end;gap:8px;padding:12px 14px;border-top:1px solid var(--line);background:#fff}
  </style>
</head>
<body>
  <header>
    <div class="head-inner">
      <div class="brand">
        <img src="https://res.cloudinary.com/dkihurh8o/image/upload/v1758795380/Logo_-_Lookerin-1_z3iqa8.png" alt="LOOKERIN logo">
      </div>
      <div class="title">
        <h1>LOOKERIN</h1>
        <p>by SIMGROUP</p>
      </div>
      <button class="hamburger" id="btn-open-filter" type="button" aria-label="Buka Filter">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 6h18M3 12h18M3 18h18"/></svg>
        Filter
      </button>
    </div>
  </header>

  <div class="wrap">
    <!-- Filters (desktop & tablet) : urutan Branch → Area → Group -->
    <section class="filters" aria-label="Filter Loker">
      <div class="row">
        <div class="fgrp">
          <label for="f-branch">Branch</label>
          <select id="f-branch" title="Pilih Branch (Kolom B)"></select>
        </div>
        <div class="fgrp">
          <label for="f-area">Area</label>
          <select id="f-area" title="Pilih Branch dulu" disabled></select>
        </div>
        <div class="fgrp">
          <label for="f-parent">Group Job</label>
          <select id="f-parent" title="Pilih Area dulu" disabled></select>
        </div>
        <div class="f-actions">
          <button class="btn btn-ghost" id="btn-clear" type="button">Clear</button>
          <button class="btn btn-primary" id="btn-apply" type="button">Terapkan</button>
        </div>
      </div>
    </section>

    <!-- Grid / Results -->
    <div id="status" class="status" role="status" aria-live="polite" aria-busy="true">Mengambil data…</div>
    <section id="grid" class="grid" hidden></section>
    <div id="pager" class="pager" hidden>
      <button class="btn btn-ghost" id="pg-prev" type="button">◀︎ Sebelumnya</button>
      <span class="page-info" id="pg-info">-</span>
      <button class="btn btn-primary" id="pg-next" type="button">Berikutnya ▶︎</button>
    </div>
  </div>

  <!-- Modal Detail -->
  <dialog id="dlg">
    <div class="modal">
      <button class="x" id="dlg-x" aria-label="Tutup">×</button>
      <div class="title"><h2 id="dlg-job">-</h2></div>
      <div class="sub" id="dlg-parent">-</div>
      <div class="meta">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a7 7 0 0 0-7 7c0 5.25 7 13 7 13s7-7.75 7-13a7 7 0 0 0-7-7Zm0 9.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5Z"/></svg>
        <span id="dlg-area">-</span>
      </div>
      <div class="meta sal-meta">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 7h18a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V8a1 1 0 0 1 1-1Zm3 2v6m12-6v6"/><circle cx="12" cy="12" r="2.5"/></svg>
        <span id="dlg-salary">-</span>
      </div>
      <div class="qual" id="dlg-qual">-</div>
      <div class="actions">
        <a class="btn btn-primary apply-btn" id="dlg-apply" href="apply.html" target="_blank" rel="noopener noreferrer" title="Apply via LOOKERIN">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M5 12h9M12 5l7 7-7 7"/></svg>
          Apply
        </a>
        <button class="btn btn-ghost" id="dlg-close" type="button">Tutup</button>
      </div>
    </div>
  </dialog>

  <!-- Dialog Filter Mobile (urutan sama) -->
  <dialog id="dlg-filter">
    <div class="mfilter-hd">
      <strong>Filter</strong>
      <button class="btn btn-ghost" id="mf-close" type="button">Tutup</button>
    </div>
    <div class="mfilter-bd">
      <div class="mfilter-row">
        <div class="fgrp">
          <label for="mf-branch">Branch</label>
          <select id="mf-branch"></select>
        </div>
        <div class="fgrp">
          <label for="mf-area">Area</label>
          <select id="mf-area" title="Pilih Branch dulu" disabled></select>
        </div>
        <div class="fgrp">
          <label for="mf-parent">Group Job</label>
          <select id="mf-parent" title="Pilih Area dulu" disabled></select>
        </div>
      </div>
    </div>
    <div class="mfilter-ft">
      <button class="btn btn-ghost" id="mf-clear" type="button">Clear</button>
      <button class="btn btn-primary" id="mf-apply" type="button">Terapkan</button>
    </div>
  </dialog>

  <div id="dbg" style="position:fixed;left:8px;bottom:8px;background:#00000099;color:#fff;padding:6px 8px;border-radius:8px;font:12px/1.3 ui-monospace,Menlo,monospace;z-index:9999;max-width:80vw;display:none"></div>

  <script>
  (function(){
    'use strict';
    // ====== CONFIG ======
    const DOC_ID = '1ESGkZf2P_0XMnyJgb7wN_L_Xo144nO6GPg30rrBZW58';
    const SHEET  = 'Sheet1';
    const GID    = '0';
    const APPLY_URL = 'apply.html';

    // Endpoints (prioritas CSV by gid)
    const GVIZ_JSON_SHEET = `https://docs.google.com/spreadsheets/d/${DOC_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET)}`;
    const GVIZ_JSON_GID   = `https://docs.google.com/spreadsheets/d/${DOC_ID}/gviz/tq?tqx=out:json&gid=${GID}`;
    const GVIZ_CSV_SHEET  = `https://docs.google.com/spreadsheets/d/${DOC_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET)}`;
    const GVIZ_CSV_GID    = `https://docs.google.com/spreadsheets/d/${DOC_ID}/gviz/tq?tqx=out:csv&gid=${GID}`;
    const EXPORT_CSV_GID  = `https://docs.google.com/spreadsheets/d/${DOC_ID}/export?format=csv&gid=${GID}`;
    const EXPORT_CSV_SHEET= `https://docs.google.com/spreadsheets/d/${DOC_ID}/export?format=csv&sheet=${encodeURIComponent(SHEET)}`;
    const MIRROR = u => 'https://r.jina.ai/https/' + u.replace(/^https?:\/\//,'');

    // Kolom: B=Branch, C=Area, D=Nama Job, E=Group Job, F=Kualifikasi, G=Salary, H=Status
    const COL = { BRANCH:1, AREA:2, JOB_NAME:3, JOB_PARENT:4, QUAL:5, SALARY:6, STATUS:7 };
    const CACHE_KEY = 'lookerin_cache_v13';

    // ====== Elemen ======
    const $grid = document.getElementById('grid');
    const $status = document.getElementById('status');
    const $pager = document.getElementById('pager');
    const $pgPrev = document.getElementById('pg-prev');
    const $pgNext = document.getElementById('pg-next');
    const $pgInfo = document.getElementById('pg-info');

    const $branch = document.getElementById('f-branch');
    const $area   = document.getElementById('f-area');
    const $parent = document.getElementById('f-parent');
    const $btnApply = document.getElementById('btn-apply');
    const $btnClear = document.getElementById('btn-clear');

    const $dlg = document.getElementById('dlg');
    const $dJob = document.getElementById('dlg-job');
    const $dArea = document.getElementById('dlg-area');
    const $dParent = document.getElementById('dlg-parent');
    const $dQual = document.getElementById('dlg-qual');
    const $dSalary = document.getElementById('dlg-salary');
    const $dlgX = document.getElementById('dlg-x');
    const $dlgClose = document.getElementById('dlg-close');
    const $dlgApply = document.getElementById('dlg-apply');

    const $openFilter = document.getElementById('btn-open-filter');
    const $dlgFilter = document.getElementById('dlg-filter');
    const $mfBranch = document.getElementById('mf-branch');
    const $mfArea = document.getElementById('mf-area');
    const $mfParent = document.getElementById('mf-parent');
    const $mfApply = document.getElementById('mf-apply');
    const $mfClear = document.getElementById('mf-clear');
    const $mfClose = document.getElementById('mf-close');

    let rows = [];
    let page = 1;
    let pageSize = 12;
    let filtered = [];

    // ====== Util ======
    const collator = new Intl.Collator('id');
    const esc = s => String(s == null ? '' : s).replace(/[&<>"']/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
    const norm = s => String(s == null ? '' : s).trim();
    const toKey = s => norm(s).toLowerCase();
    const uniqNorm = (arr) => { const map = new Map(); for(const v of arr){ const k = toKey(v); if(k && !map.has(k)) map.set(k, v); } return [...map.values()].sort((a,b)=>collator.compare(a,b)); };

    function setOptions(el, list, placeholder){
      el.innerHTML = `<option value="">${placeholder}</option>` + list.map(v=>`<option value="${esc(v)}">${esc(v)}</option>`).join('');
    }

    function looksLikeHeader(r0){
      const base = (r0||[]).map(x=>String(x||'').toLowerCase());
      const keys = ['branch','area','nama job','job parent','group job','kualifikasi','salary','gaji','status'];
      return keys.some(k => base.includes(k));
    }
    function stripHeader(arr){ if(!arr || !arr.length) return arr || []; return looksLikeHeader(arr[0]) ? arr.slice(1) : arr; }

    function parseCSV(text){
      const out=[]; let row=[]; let cur=''; let inQ=false;
      for(let i=0;i<text.length;i++){
        const c=text[i];
        if(c==='"'){ if(inQ && text[i+1]==='"'){ cur+='"'; i++; } else inQ=!inQ; }
        else if(c===',' && !inQ){ row.push(cur); cur=''; }
        else if((c==='\n' || c==='\r') && !inQ){ if(c==='\r' && text[i+1]==='\n') i++; row.push(cur); out.push(row); row=[]; cur=''; }
        else { cur+=c; }
      }
      if(cur.length>0 || row.length){ row.push(cur); out.push(row); }
      const cleaned = out.filter(r=> r && r.some(cell => String(cell||'').trim().length));
      return stripHeader(cleaned);
    }
    function parseGVizJSON(txt){
      try{
        const json = JSON.parse(txt.slice(txt.indexOf('(')+1, txt.lastIndexOf(')')));
        const rs = (json.table && json.table.rows) ? json.table.rows : [];
        const arr = rs.map(r => (r.c||[]).map(c => c ? (c.f ?? c.v ?? '') : ''));
        return arr.filter(r=> r && r.some(cell => String(cell||'').trim().length));
      } catch{ return []; }
    }
    async function fetchWithTimeout(url, ms=15000){
      const ctrl = new AbortController(); const id = setTimeout(()=>ctrl.abort(), ms);
      try{
        const r = await fetch(url, {mode:'cors', cache:'no-cache', signal: ctrl.signal});
        if(!r.ok) throw new Error('HTTP '+r.status);
        return await r.text();
      } finally { clearTimeout(id); }
    }
    async function getData(){
      const order = [
        EXPORT_CSV_GID,
        GVIZ_CSV_GID,
        GVIZ_JSON_GID,
        EXPORT_CSV_SHEET,
        GVIZ_CSV_SHEET,
        GVIZ_JSON_SHEET,
        MIRROR(EXPORT_CSV_GID),
        MIRROR(GVIZ_CSV_GID),
        MIRROR(GVIZ_JSON_GID),
        MIRROR(EXPORT_CSV_SHEET),
        MIRROR(GVIZ_CSV_SHEET),
        MIRROR(GVIZ_JSON_SHEET)
      ];
      let best = null, lastErr = '';
      for(const url of order){
        try{
          const text = await fetchWithTimeout(url);
          const arr = url.includes('out:json') ? parseGVizJSON(text) : parseCSV(text);
          if(arr && arr.length){
            if(!best || arr.length > best.rows.length){ best = {rows: arr, source: url}; }
            if(arr.length >= 20) break;
          }
        }catch(e){ lastErr = e.message; }
      }
      if(best) return best;
      throw new Error('Semua sumber gagal ('+ lastErr +'). Pastikan Tab target dapat diakses publik (Viewer).');
    }

    // ====== Dependent options: Branch → Area → Group
    function updateAreaOptions(){
      const bKey = toKey($branch.value);
      const areas = uniqNorm(
        rows
          .filter(r => !bKey || toKey(r[COL.BRANCH]) === bKey)
          .map(r => r[COL.AREA] || '')
      );
      setOptions($area, areas, bKey ? 'Semua Area' : 'Pilih Branch dulu');
      $area.disabled = !bKey || areas.length === 0;

      // Reset & update Group Job setelah area berubah
      $parent.value = '';
      updateParentOptions();
    }

    function updateParentOptions(){
      const bKey = toKey($branch.value);
      const aKey = toKey($area.value);
      const parents = uniqNorm(
        rows
          .filter(r => (!bKey || toKey(r[COL.BRANCH]) === bKey) && (!aKey || toKey(r[COL.AREA]) === aKey))
          .map(r => r[COL.JOB_PARENT] || '')
      );
      setOptions($parent, parents, (bKey && aKey) ? 'Semua Group Job' : 'Pilih Area dulu');
      $parent.disabled = !(bKey && aKey) || parents.length === 0;
    }

    function updateMobileAreaOptions(){
      const bKey = toKey($mfBranch.value || $branch.value);
      const areas = uniqNorm(
        rows
          .filter(r => !bKey || toKey(r[COL.BRANCH]) === bKey)
          .map(r => r[COL.AREA] || '')
      );
      setOptions($mfArea, areas, bKey ? 'Semua Area' : 'Pilih Branch dulu');
      $mfArea.disabled = !bKey || areas.length === 0;

      $mfParent.value = '';
      updateMobileParentOptions();
    }

    function updateMobileParentOptions(){
      const bKey = toKey($mfBranch.value || $branch.value);
      const aKey = toKey($mfArea.value || $area.value);
      const parents = uniqNorm(
        rows
          .filter(r => (!bKey || toKey(r[COL.BRANCH]) === bKey) && (!aKey || toKey(r[COL.AREA]) === aKey))
          .map(r => r[COL.JOB_PARENT] || '')
      );
      setOptions($mfParent, parents, (bKey && aKey) ? 'Semua Group Job' : 'Pilih Area dulu');
      $mfParent.disabled = !(bKey && aKey) || parents.length === 0;
    }

    function fillFilters(){
      // Branch global dulu
      const branches = uniqNorm(rows.map(r => r[COL.BRANCH]||''));
      setOptions($branch, branches, 'Semua Branch');
      // Area & Group mengikuti (awalnya disabled)
      updateAreaOptions();

      // Mobile
      setOptions($mfBranch, branches, 'Semua Branch');
      updateMobileAreaOptions();
    }

    // ====== Icons & card helpers
    const I = {
      briefcase:'<svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M9 4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2h3a2 2 0 0 1 2 2v9a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V8a2 2 0 0 1 2-2h3V4Zm2 0v2h2V4h-2Z"/></svg>',
      tag:'<svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M3 12V5h7l7 7-7 7-7-7Zm12-5a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/></svg>',
      fire:'<svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M13.5 2.1s1.7 3.3-.8 5.8c0 0-.3-2.2-2.3-3.6 0 0 .7 2.4-1.2 4.1C7.1 9 6 10.9 6 13a6 6 0 0 0 12 0c0-2.3-1.2-3.9-2.6-5.3-.9-.9-1.6-1.7-1.9-2.8Z"/></svg>',
      dot:'<svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><circle cx="12" cy="12" r="6"/></svg>'
    };
    function iconFor(parentName){ const k=(parentName||'').toLowerCase(); let svg=I.briefcase; if(k.includes('sales')) svg=I.tag; return `<span class="i" aria-hidden="true">${svg}</span>`; }

    function statusCapsule(status){
      const s = toKey(status||'');
      if(!s) return '';
      if(s.includes('urgent')){
        return `<div class="cap-status urgent" aria-label="Urgent hiring"><span class="ico">${I.fire}</span><span class="lbl">URGENT</span></div>`;
      }
      if(s.includes('always')){
        return `<div class="cap-status hiring" aria-label="Selalu membuka lowongan"><span class="ico">${I.dot}</span><span class="lbl">ALWAYS HIRING</span></div>`;
      }
      return '';
    }

    function templateCard(r, idx){
      const job   = esc(r[COL.JOB_NAME]||'');
      const par   = esc(r[COL.JOB_PARENT]||'');
      const area  = esc(r[COL.AREA]||'-');
      const sal   = esc(r[COL.SALARY]||'');
      const stat  = esc(r[COL.STATUS]||'');
      const icon  = iconFor(par);
      return `
        <article class="card" data-i="${idx}" tabindex="0" role="button" aria-label="Lihat detail ${job || '-'}">
          ${statusCapsule(stat)}
          <div class="job-title">${icon}<span>${job || '-'}</span></div>
          <div class="job-parent">${icon}<span>${par || '-'}</span></div>
          <div class="loc">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a7 7 0 0 0-7 7c0 5.25 7 13 7 13s7-7.75 7-13a7 7 0 0 0-7-7Zm0 9.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5Z"/></svg>
            <span>${area}</span>
          </div>
          <div class="sal">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 7h18a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V8a1 1 0 0 1 1-1Zm3 2v6m12-6v6"/><circle cx="12" cy="12" r="2.5"/></svg>
            <span>${sal || '-'}</span>
          </div>
          <div class="card-ft">
            <button class="pill pill-detail" type="button" aria-label="Lihat detail ${job}">Detail</button>
          </div>
        </article>`;
    }

    // ====== Filtering
    function applyFilter(){
      const bKey = toKey($branch.value);
      const aKey = toKey($area.value);
      const pKey = toKey($parent.value);
      filtered = rows.filter(r => {
        const rBranch = toKey(r[COL.BRANCH]);
        const rArea   = toKey(r[COL.AREA]);
        const rParent = toKey(r[COL.JOB_PARENT]);
        const okB = bKey ? rBranch === bKey : true;
        const okA = aKey ? rArea === aKey : true;
        const okP = pKey ? rParent === pKey : true;
        return okB && okA && okP;
      });
      page = 1;
      renderPage();
    }

    function renderPage(){
      if(!filtered.length){
        $grid.hidden = true; $status.hidden = false; $pager.hidden = true; $status.textContent = 'Tidak ada data yang cocok dengan filter.'; $status.setAttribute('aria-busy','false');
        return;
      }
      const total = filtered.length;
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      page = Math.min(Math.max(1, page), totalPages);
      const start = (page-1)*pageSize;
      const end   = Math.min(start + pageSize, total);

      $status.hidden = true; $grid.hidden = false; $grid.innerHTML = '';
      const slice = filtered.slice(start, end);
      let html='';
      for(let i=0;i<slice.length;i++){ html += templateCard(slice[i], start + i); }
      $grid.insertAdjacentHTML('beforeend', html);

      document.getElementById('pager').hidden = false;
      $pgInfo.textContent = `Halaman ${page} dari ${totalPages} • ${total} job`;
      $pgPrev.disabled = page<=1; $pgNext.disabled = page>=totalPages;
      adjustMinHeight();
    }

    function adjustMinHeight(){
      const headH = document.querySelector('header').getBoundingClientRect().height;
      let filterH = 0; const f = document.querySelector('.filters'); if(f && getComputedStyle(f).display!=='none') filterH = f.getBoundingClientRect().height + 12;
      const vh = window.innerHeight; const minH = Math.max(160, vh - headH - filterH - 32);
      $grid.style.minHeight = minH + 'px';
      $status.style.minHeight = minH + 'px';
    }

    function qualToHTML(s){
      const raw = String(s||'').trim();
      if(!raw) return '-';
      let parts = raw.split(/\r?\n/).map(t=>t.trim()).filter(Boolean);
      if(parts.length <= 1){ parts = raw.split(/[•\u2022;]+/).map(t=>t.trim()).filter(Boolean); }
      if(parts.length <= 1 && /(^|\s)-\s+/.test(raw)){ parts = raw.split(/\s*-\s+/).map(t=>t.trim()).filter(Boolean); }
      parts = parts.map(t=>t.replace(/^[-•\u2022]\s*/, '').trim()).filter(Boolean);
      if(!parts.length) return esc(raw);
      return '<ul>' + parts.map(li => `<li>${esc(li)}</li>`).join('') + '</ul>';
    }

    function openModalByIndex(absIndex){
      const r = filtered[absIndex] || [];
      const job = r[COL.JOB_NAME], parent = r[COL.JOB_PARENT], area = r[COL.AREA], qual = r[COL.QUAL], sal = r[COL.SALARY];
      $dJob.textContent = job || '-';
      $dParent.textContent = parent ? `Group Job: ${parent}` : '-';
      $dArea.textContent = area || '-';
      $dSalary.textContent = sal || '-';
      $dQual.innerHTML = qualToHTML(qual || '');
      const params = new URLSearchParams({ job: job || '', area: area || '' });
      $dlgApply.href = `${APPLY_URL}?${params.toString()}`;
      if(typeof $dlg.showModal === 'function') $dlg.showModal(); else $dlg.setAttribute('open','');
    }
    function closeModal(){ if($dlg.open) $dlg.close(); else $dlg.removeAttribute('open'); }

    // ====== Events ======
    document.addEventListener('click', e => {
      if(e.target.closest('.pill-detail')){
        const card = e.target.closest('.card');
        if(card){ openModalByIndex(Number(card.dataset.i)); return; }
      }
      const card = e.target.closest('.card');
      if(card && $grid.contains(card)){ openModalByIndex(Number(card.dataset.i)); }
    });
    document.addEventListener('keydown', e => {
      const card = e.target.closest('.card');
      if(card && (e.key === 'Enter' || e.key === ' ')){ e.preventDefault(); openModalByIndex(Number(card.dataset.i)); }
    });

    $dlgX.addEventListener('click', closeModal);
    $dlgClose.addEventListener('click', closeModal);

    // Filter desktop
    $btnApply.addEventListener('click', applyFilter);
    $btnClear.addEventListener('click', ()=>{
      $branch.value=''; $area.value=''; $parent.value='';
      updateAreaOptions(); // ini juga akan updateParentOptions & disable sesuai state
      applyFilter();
    });
    $branch.addEventListener('change', ()=>{ updateAreaOptions(); applyFilter(); });
    $area.addEventListener('change', ()=>{ updateParentOptions(); applyFilter(); });
    $parent.addEventListener('change', applyFilter);

    // Pager
    $pgPrev.addEventListener('click', ()=>{ page--; renderPage(); window.scrollTo({top:0,behavior:'smooth'}); });
    $pgNext.addEventListener('click', ()=>{ page++; renderPage(); window.scrollTo({top:0,behavior:'smooth'}); });

    // Filter Mobile
    $openFilter.addEventListener('click', ()=>{
      $mfBranch.value = $branch.value || '';
      updateMobileAreaOptions();
      $mfArea.value = $area.value || '';
      updateMobileParentOptions();
      $mfParent.value = $parent.value || '';
      if(typeof $dlgFilter.showModal === 'function') $dlgFilter.showModal(); else $dlgFilter.setAttribute('open','');
    });
    $mfBranch.addEventListener('change', ()=>{ updateMobileAreaOptions(); $mfParent.value=''; });
    $mfArea.addEventListener('change', ()=>{ updateMobileParentOptions(); });
    $mfApply.addEventListener('click', ()=>{
      $branch.value = $mfBranch.value;
      $area.value   = $mfArea.value;
      updateAreaOptions(); // memastikan state enable/opsi sinkron
      $parent.value = $mfParent.value;
      applyFilter();
      if($dlgFilter.open) $dlgFilter.close();
    });
    $mfClear.addEventListener('click', ()=>{
      $mfBranch.value=''; $mfArea.value=''; $mfParent.value='';
      updateMobileAreaOptions(); updateMobileParentOptions();
    });
    $mfClose.addEventListener('click', ()=>{ if($dlgFilter.open) $dlgFilter.close(); });

    // ====== Init ======
    (async function init(){
      const head = document.querySelector('header');
      const updateSticky = ()=> document.documentElement.style.setProperty('--sticky-top', head.getBoundingClientRect().height + 'px');
      updateSticky();
      window.addEventListener('resize', ()=>{ updateSticky(); renderPage(); adjustMinHeight(); });

      try{
        const cache = localStorage.getItem(CACHE_KEY);
        if(cache){
          const cached = JSON.parse(cache);
          if(Array.isArray(cached.rows) && cached.rows.length){
            rows = cached.rows;
            fillFilters(); applyFilter();
          }
        }
        const res = await getData();
        rows = stripHeader(res.rows || res) || [];
        rows = rows.filter(r => r && (String(r[COL.JOB_NAME]||'').trim() || String(r[COL.JOB_PARENT]||'').trim() || String(r[COL.AREA]||'').trim() || String(r[COL.BRANCH]||'').trim()));
        localStorage.setItem(CACHE_KEY, JSON.stringify({rows}));
        fillFilters(); applyFilter();
        $status.hidden = true; $grid.hidden = false; $status.setAttribute('aria-busy','false');
      }catch(err){
        console.error('[LOOKERIN] load fail', err);
        if(!rows.length){ $status.textContent = 'Gagal memuat data: ' + err.message; $status.setAttribute('aria-busy','false'); }
      }
      adjustMinHeight();
    })();

    // Toast setelah submit (opsional)
    (function(){
      const q = new URLSearchParams(location.search);
      if (q.get('submitted') === '1') {
        const job  = q.get('job')  || '';
        const area = q.get('area') || '';
        const cvok = q.get('cv_ok') === '1';
        const t = document.createElement('div');
        t.className = 'toast ' + (cvok ? 'toast-ok' : 'toast-err');
        t.textContent = cvok
          ? `Lamaran terkirim${job?` • ${job}`:''}${area?` • ${area}`:''}`
          : `Lamaran terkirim, namun CV belum terunggah. Mohon kirim ulang dengan file.`;
        document.body.appendChild(t);
        setTimeout(()=> t.remove(), 5000);
        const url = new URL(location.href);
        ['submitted','job','area','cv_ok'].forEach(k=> url.searchParams.delete(k));
        history.replaceState({}, '', url);
      }
    })();
  })();
  </script>
</body>
</html>
